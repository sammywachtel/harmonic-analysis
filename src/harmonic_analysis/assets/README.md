# Harmonic Analysis Assets

This directory contains **production assets** for the harmonic analysis library that are loaded at runtime.

## Production Files

### `calibration_mapping.json`
Production-ready calibration mapping for confidence score calibration. This file is automatically loaded by the library when present.

- **Purpose**: Runtime confidence calibration for harmonic analysis results
- **Generated by**: `tools/calibration/notebooks/Confidence_Calibration_Enhanced.ipynb`
- **Source location**: `tools/calibration/calibration_mapping.json` (development)
- **Schema**: 4-stage calibration pipeline with Platt scaling, isotonic regression, bucket models, and uncertainty adjustment

## How Calibration Works

### Automatic Loading
The PatternAnalysisService automatically loads calibration mappings from this directory:

```python
from harmonic_analysis.services.pattern_analysis_service import PatternAnalysisService

# Automatically loads from assets/calibration_mapping.json if it exists
service = PatternAnalysisService()  # auto_calibrate=True by default
result = await service.analyze_with_patterns_async(['C', 'F', 'G', 'C'])
# Result confidence scores are automatically calibrated
```

### Manual Loading
For explicit control over calibration:

```python
from harmonic_analysis.services.calibration_service import CalibrationService

# Manually load calibration mapping
calibration = CalibrationService("src/harmonic_analysis/assets/calibration_mapping.json")

# Apply calibration to raw confidence scores
calibrated = calibration.calibrate_confidence(
    raw_confidence=0.85,
    track="functional",  # or "modal"
    features={
        "chord_count": 4,
        "evidence_strength": 0.7,
        "has_flat7": False
    }
)
```

## Deployment Process

Calibration mappings are deployed from the development environment to production:

1. **Development**: Calibration is trained in `tools/calibration/` using the notebook
2. **Validation**: The notebook validates calibration performance
3. **Deployment**: The notebook's deployment cell copies the mapping here with automatic backup
4. **Backup**: Previous versions are saved as `calibration_mapping_backup_YYYYMMDD_HHMMSS.json`
5. **Rotation**: Only the 5 most recent backups are kept

## Calibration Documentation

For detailed information about the calibration system:

- **ðŸ“š Main Documentation**: [`tools/calibration/README_CALIBRATION.md`](../../../tools/calibration/README_CALIBRATION.md)
- **ðŸ““ Interactive Notebook**: [`tools/calibration/notebooks/Confidence_Calibration_Enhanced.ipynb`](../../../tools/calibration/notebooks/Confidence_Calibration_Enhanced.ipynb)
- **ðŸ”§ Baseline Export Script**: [`scripts/export_baseline.py`](../../../scripts/export_baseline.py) - Generates baseline data for notebook training
- **ðŸ“Š Confidence Documentation**: [`docs/CONFIDENCE_CALIBRATION.md`](../../../docs/CONFIDENCE_CALIBRATION.md)

## File Structure

```
src/harmonic_analysis/assets/
â”œâ”€â”€ README.md                                    # This file
â”œâ”€â”€ calibration_mapping.json                     # Production calibration (when deployed)
â””â”€â”€ calibration_mapping_backup_*.json            # Automatic backups (up to 5)
```

## Monitoring

To verify calibration is working:

```python
import logging
logging.basicConfig(level=logging.INFO)

# The service will log calibration activity
service = PatternAnalysisService()
# Look for: "âœ… Loaded calibration service from ..."
# Or: "ðŸ“‚ No calibration mapping found at ..."
```

## Rollback Procedure

If calibration needs to be rolled back:

1. Identify the backup to restore: `ls -la calibration_mapping_backup_*.json`
2. Copy the backup over the production file: `cp calibration_mapping_backup_YYYYMMDD_HHMMSS.json calibration_mapping.json`
3. Restart any running services to reload the calibration

---

**Note**: This directory should only contain production-ready calibration files. Development and testing of calibration should be done in `tools/calibration/`.
